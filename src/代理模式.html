<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>代理模式</title>
</head>
<body>
<input type="checkbox" id="1"/>1
<input type="checkbox" id="2"/>2
<input type="checkbox" id="3"/>3
<input type="checkbox" id="4"/>4
<input type="checkbox" id="5"/>5
<input type="checkbox" id="6"/>6
<input type="checkbox" id="7"/>7
<input type="checkbox" id="8"/>8
<input type="checkbox" id="9"/>9
</body>
<script>
  /*
  代理模式的关键是，当客户不方便直接访问一个对象或者不满足需要的时候，提供一个替身 对象来控制对这个对象的访问，客户实际上访问的是替身对象。替身对象对请求做出一些处理之 后，再把请求转交给本体对象
   */

  // 虚拟代理实现图片预加载
  // 图片预加载是一种常用的技术，如果直接给某个 img 标签节点设置 src 属性， 由于图片过大或者网络不佳，图片的位置往往有段时间会是一片空白。常见的做法是先用一张 loading 图片占位，然后用异步的方式加载图片，等图片加载好了再把它填充到 img 节点里，这种 场景就很适合使用虚拟代理
  // var myImage = (function () {
  //   var imgNode = document.createElement('img')
  //   document.body.appendChild(imgNode)
  //   return {
  //     setSrc: function (src) {
  //       imgNode.src = src
  //     }
  //   }
  // })()
  //
  // myImage.setSrc('https://www.baidu.com/img/dong_96c3c31cae66e61ed02644d732fcd5f8.gif')

  // 虚拟代理合并HTTP请求
  // 给这些 checkbox 绑定点击事件，并且在点击的同时往另一台服务器同步文件
  var synchronousFile = function (id) {
    console.log('开始同步文件，id 为: ' + id)
  }
  var checkbox = document.getElementsByTagName('input')
  for (var i = 0, c; c = checkbox[i++];) {
    c.onclick = function () {
      if (this.checked === true) {
        synchronousFile(this.id)
      }
    }
  }

  /*
  解决方案是，我们可以通过一个代理函数 proxySynchronousFile 来收集一段时间之内的请求， 最后一次性发送给服务器。比如我们等待 2 秒之后才把这 2 秒之内需要同步的文件 ID 打包发给 服务器，如果不是对实时性要求非常高的系统，2 秒的延迟不会带来太大副作用，却能大大减轻 服务器的压力。代码如下:
   */
  var synchronousFile = function (id) {
    console.log( '开始同步文件，id 为: ' + id )
  }

  var proxySynchronousFile = (function () {
    var cache = [] // 保存一段时间需要同步的id
    var timer = null // 定时器
    return function (id) {
      cache.push(id)
      if (timer) { // 保证不会覆盖已经启动的定时器
        return false
      }
      timer = setTimeout(function () {
        synchronousFile(cache.join(',')) // 2 秒后向本体发送需要同步的 ID 集合
        clearTimeout(timer) // 清空定时器
        timer = null
        cache.length = 0 // 清空 ID 集合
      }, 2000)
    }
  })()

    var checkbox = document.getElementsByTagName('input')
    for (var i = 0, c; c = checkbox[i++];) {
      c.onclick = function () {
        if (this.checked) {
          proxySynchronousFile(this.id)
        }
      }
    }
</script>
</html>
